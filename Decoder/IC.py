import torch
from torch_geometric.data import Data
import random
import numpy as np
import scipy.sparse as sp
import pickle
from torch_geometric.utils import degree
import torch
from torch_geometric.data import Data


def normalize_adj(mx):
    """Row-normalize sparse matrix（行规范化稀疏矩阵）"""
    rowsum = np.array(mx.sum(1))  # 每行相加的和
    r_inv_sqrt = np.power(rowsum, -0.5).flatten()
    r_inv_sqrt[np.isinf(r_inv_sqrt)] = 0.
    r_mat_inv_sqrt = sp.diags(r_inv_sqrt)  # 生成对角矩阵
    return mx.dot(r_mat_inv_sqrt).transpose().dot(r_mat_inv_sqrt)  # transpose函数相当于换索引位置，类似于转置


with open('/home/pmy/DeepIM/data/cora-ICI-20.pkl', 'rb') as f:
    graph = pickle.load(f)

adj, inverse_pairs = graph['adj'], graph['inverse_pairs']

num_node = adj.shape[0]
dataFea = torch.zeros([num_node, 1], dtype=torch.float32)

adj = adj + adj.T.multiply(adj.T > adj) - adj.multiply(adj.T > adj)
adj = normalize_adj(adj + sp.eye(adj.shape[0]))
adj = torch.Tensor(adj.toarray()).to_sparse()

index = adj.indices()
e = adj.values()
# directed_edge_index = torch.cat([index, index.flip(0)], dim=1)
num_node = adj.shape[0]
out_degree = degree(index[0], num_nodes=num_node, dtype=torch.float)
for a in out_degree:
    print(a)
# Step 4: 计算每条边的权值，即目标节点入度的倒数
edge_weight = 1.0 / out_degree[index[0]]
#
# # Step 5: 创建新的图数据对象 (Graph Data Object)
# data = Data(edge_index=directed_edge_index, edge_weight=edge_weight, num_nodes=num_node)

graph = Data(num_nodes=num_node, edge_index=index, edge_attr=e+edge_weight)

# 定义种子节点集-JAZZ-79%-198
# seed_nodes_20 = [190, 161,  74,  7,  59, 195,  58,  72, 122,  39, 112,  79, 167, 187,
#         116,  43,  40, 102,  65,  68, 139, 183,  18,  62, 127,  36,  60,  24,
#         176, 129, 119, 47, 105, 154,  29, 109,  94,  38, 146, 136]
#
# seed_nodes_5 = [190, 161,  74,   7,  59, 195,  58,  72, 122,  39]
# seed_nodes_10 = [190, 161,  74,   7,  59, 195,  58,  72, 122,  39, 112,  79, 167, 187,
#         116,  43,  40, 102,  65,  68]
# seed_nodes_1 = [190, 161]

#定义种子节点集-CORA_ML-86%-2810
# seed_nodes_20 = [2764, 2681, 2656,  631, 2134, 2614,  463, 1784,   87, 1814, 1476, 1739,
#          1306, 1591, 1395, 1375, 2704,  551, 1462, 1790, 1506, 2666,  193,   51,
#           201, 1821, 2338, 2020, 1853,  525,  786, 2647, 1681,  122,  531,  843,
#           705, 1280,   49, 2096, 1226,  165, 2195,  696, 2705,  679,  981, 2566,
#           246, 2398, 2131, 1781, 2391, 2749,  211, 1579, 1540,  900, 1914,   40,
#           972,   15, 1508, 1098,  673, 2625,  275,   99, 1297, 1905,  776,  796,
#           178, 1412, 1964,  834, 2645, 1344, 2283,  722, 1852,   62,  753, 1230,
#           713, 1460, 1434, 1997, 1471, 1174,  562,  676,  974, 2145, 2277, 1672,
#          1826, 2433, 2754, 1348,   69,  423, 2780,  587, 1369, 1451, 2438, 2324,
#          1516,  866, 1927,  179,  272,  569,  168,  515,  433, 2151, 1662, 1535,
#          1851, 2294,  831,  887,  456,  791,   89, 2219, 1551,  493,  422, 2669,
#           755,  520, 2714, 2426, 1744,  359,  825, 1491,  630, 2549, 1246, 2570,
#          1557, 1787,  746,  320, 2322, 1673, 2155, 2745, 2672, 1686,  511, 1079,
#          1638, 1022, 1183, 1341, 1194, 1945,  579, 2567, 2177, 1795,   10,  878,
#          1007, 1406, 1196, 2147,  781, 2259,    4, 1288, 1974,   42, 2618,  408,
#          1585,  125, 1615,  914, 1537, 1041, 1715,    3, 1769,  619, 1310,  478,
#          1648,  300,  386,  457,  461, 1397, 1675, 2613,  298, 2546, 1836, 2152,
#           701, 1614, 1319,   94, 1890, 2320,  583,  524, 1755,  529,  342, 2520,
#           876, 1458, 1729, 2684, 1605, 2323,  992, 1909,  249, 2751,  546, 2361,
#          2624, 1573, 2489, 1677,  189,  885, 1101, 2300,  350, 2029, 2535, 2365,
#           800, 1679, 1877, 1805,  904, 1817,  667,  804, 2122, 2328,  256, 1317,
#          1704, 2765,  371, 1976, 1454, 1251, 2104, 1897,  158,  417, 2221,  929,
#          1582,  443, 1298, 1346,  129, 1295,  618, 2746, 2202, 2369,  864, 1720,
#           541, 2226, 1466, 1847,  853, 1678,  559, 2502, 2386,  726, 1002, 2183,
#           644,  402,  911,   29, 1300,  875,  815,  740,  223,  918, 2080,  549,
#          2181,  333,  732, 1696,  826, 2574, 2527,   17, 1037, 2085, 2024,   59,
#          1513, 1473, 2413, 2770, 2069,   96, 1173,  170, 1062, 2410,  612, 1351,
#          2702, 1523,   85,  869, 2592, 1303, 1370,  533, 1040,  840, 1512, 2331,
#           182, 1968,  595, 1789, 1394, 1823, 1480,  692,  807,  986,  708, 2040,
#          1301, 2554,   35,  859, 1687, 1716, 2165,  536,  195, 2348, 2112, 1706,
#          2058,  186, 2510, 1235, 2648, 2469, 1665, 1448, 2736,  965, 2189, 1981,
#          2230,  481, 1907,  234, 1598, 1651, 2725, 1453, 2650, 1692, 1941, 1985,
#          2550,  145, 2023,  735,  634, 1154,  797,  504,  933, 2411,  236, 1493,
#          1350, 1440, 1077, 2655,  297, 2233, 1410, 2289,  181, 2798, 2708, 1187,
#          2161, 1142, 1158,  156,  116,  106, 2148, 2530, 1979, 1066, 1031, 1589,
#           205,   71, 1555,  475, 1359, 1822,  799, 2481, 2638,  123, 2129, 2130,
#          2275, 2417,   46, 1875, 2687, 1820, 1505, 2731, 1859,  265, 2461, 1486,
#            39, 1960, 2213, 2218,  955, 1751,  413, 1542, 2432,  502, 2790, 2081,
#          1276,  765,  725, 2000, 2454, 2541,  677, 2062,  335,  388, 1785,  370,
#           811, 2380,  588,  829, 1259, 1993, 1195, 2089, 1792, 2308, 1039, 1337,
#          2175, 2719,  353, 2596,  662,  284,  355, 1134,  414, 2223, 1117, 2462,
#           227, 2496,  431,  877, 1211, 1602, 2054, 2404,  906,  946, 2382, 2166,
#          2168, 1721,  778, 1450, 1474,  166,    7, 2013,   58, 1843, 2556, 2514,
#          1205,  748, 2601, 1804,  789, 2022,  733,  194, 1619,  176,  594, 2802,
#          2092,  361, 1016,  954,  633, 2268, 1644,  995,  718,  458, 2354,  172,
#           835, 2333, 1761,  210, 1969, 2273, 2633, 1663,  719, 2456, 2504, 1324,
#          1017,   64, 1093, 2580, 1388, 2696, 2427, 2091, 2016, 1315]
#
# seed_nodes_10 = [2764, 2681, 2656,  631, 2134, 2614,  463, 1784,   87, 1814, 1476, 1739,
#          1306, 1591, 1395, 1375, 2704,  551, 1462, 1790, 1506, 2666,  193,   51,
#           201, 1821, 2338, 2020, 1853,  525,  786, 2647, 1681,  122,  531,  843,
#           705, 1280,   49, 2096, 1226,  165, 2195,  696, 2705,  679,  981, 2566,
#           246, 2398, 2131, 1781, 2391, 2749,  211, 1579, 1540,  900, 1914,   40,
#           972,   15, 1508, 1098,  673, 2625,  275,   99, 1297, 1905,  776,  796,
#           178, 1412, 1964,  834, 2645, 1344, 2283,  722, 1852,   62,  753, 1230,
#           713, 1460, 1434, 1997, 1471, 1174,  562,  676,  974, 2145, 2277, 1672,
#          1826, 2433, 2754, 1348,   69,  423, 2780,  587, 1369, 1451, 2438, 2324,
#          1516,  866, 1927,  179,  272,  569,  168,  515,  433, 2151, 1662, 1535,
#          1851, 2294,  831,  887,  456,  791,   89, 2219, 1551,  493,  422, 2669,
#           755,  520, 2714, 2426, 1744,  359,  825, 1491,  630, 2549, 1246, 2570,
#          1557, 1787,  746,  320, 2322, 1673, 2155, 2745, 2672, 1686,  511, 1079,
#          1638, 1022, 1183, 1341, 1194, 1945,  579, 2567, 2177, 1795,   10,  878,
#          1007, 1406, 1196, 2147,  781, 2259,    4, 1288, 1974,   42, 2618,  408,
#          1585,  125, 1615,  914, 1537, 1041, 1715,    3, 1769,  619, 1310,  478,
#          1648,  300,  386,  457,  461, 1397, 1675, 2613,  298, 2546, 1836, 2152,
#           701, 1614, 1319,   94, 1890, 2320,  583,  524, 1755,  529,  342, 2520,
#           876, 1458, 1729, 2684, 1605, 2323,  992, 1909,  249, 2751,  546, 2361,
#          2624, 1573, 2489, 1677,  189,  885, 1101, 2300,  350, 2029, 2535, 2365,
#           800, 1679, 1877, 1805,  904, 1817,  667,  804, 2122, 2328,  256, 1317,
#          1704, 2765,  371, 1976, 1454, 1251, 2104, 1897,  158,  417, 2221,  929,
#          1582,  443, 1298, 1346,  129, 1295,  618, 2746, 2202, 2369,  864, 1720,
#           541, 2226, 1466, 1847,  853]
#
seed_nodes_5 = [4458,  831, 2553, 3468, 2382, 2575, 2439, 3895, 1224, 2542, 2585, 3128,
        1005, 2617, 4448, 2282, 2434, 4345, 3355, 3838, 1030, 1334, 1460,  597,
         521, 2717, 3467, 1309, 2662, 2647, 3149,  895,  855,  856, 2801,  837,
        4459,  832, 2554, 2843, 3829, 2574,  869, 2995, 3591, 2268, 2206,  903,
        1326, 4878, 3284, 3613, 2596, 2548, 3526, 2999, 2383, 3614, 3867, 2384,
        2385, 2321,   98, 4466, 2874, 4454, 1225, 2908, 2353, 4224, 4457, 3872,
        3154, 3412, 2592, 4520, 1554, 3415, 4119, 2809, 1106, 3900, 2418, 2529,
        4465, 3592, 4455, 1082, 2544, 2545, 1647, 3479,  829, 4463,   99, 2922,
        3303,  845, 1100,   88, 1077, 1050,  129,  725,  274,  848, 3351, 3096,
        3788, 2289, 3920, 2249, 3312, 1601,  490, 3469, 3307, 2845, 3837, 1026,
        2248, 2601, 3207, 4444, 2800, 3830, 2562,  867, 3329, 2885, 3010,  854,
        1746,  535, 2905, 2682, 2264, 2136,  509,  910, 3432, 2932, 1547, 3470,
        4265, 1160, 2095,  514, 2395, 3310, 1104, 2880, 2398,  188, 2683, 2221,
        1511,  569, 1536, 3411, 1732, 1432, 4852, 2440, 3442,  601,  905, 2232,
        4209, 3789, 2253, 2409,  803, 3796, 1435, 2765, 1098,  396, 1371, 1506,
        3305, 1483, 4609, 1678, 2516, 1308, 3870,   24, 3502, 3170, 3923, 2586,
        1089, 2538, 3199, 1983, 3809, 1703, 2341, 2805, 2997,  483, 2110, 1335,
        3304, 3431,  407, 3456, 3118, 2851,  851, 2620, 4823,  906, 2794, 2397,
        3766, 3959, 4247,  466, 2728,  356, 1760, 3429, 2870, 4294, 2720, 4619,
        4053, 3064, 4447, 2618, 1166, 2431, 4181,  668, 2925, 2722, 1695,  186,
        1398, 2144, 1926, 3744, 3665,   95, 2639]
# #
#
# seed_nodes_1 = [2764, 2681, 2656,  631, 2134, 2614,  463, 1784,   87, 1814, 1476, 1739,
#          1306, 1591, 1395, 1375, 2704,  551, 1462, 1790, 1506, 2666,  193,   51,
#           201, 1821, 2338, 2020]
#powder-grid-mean数据集
# seed_nodes_1 = [4542, 4891, 3324, 3663,    3, 2569, 2688, 2622, 3815, 2677, 1498, 4824,
#          4195, 4642, 3826, 1569,  633,  785, 3425, 3470, 4877, 4565, 4584, 3831,
#           892, 3737,  967, 4498, 2575, 3212,  981,  925, 1954, 3835, 2982, 3735,
#          2703, 3069, 3223,  483, 3335, 2305, 2061, 3635,  831, 3959, 4294, 2417,
#          4444]
seed_nodes_1 = [4542, 4891,    3, 3663, 2688, 1565, 1983,  483,  633, 3324, 3635, 4195,
         2569, 4444, 1569, 1498, 1773, 4788, 3831, 2195,  600,  634, 3569, 4642,
         2421, 4877, 3069,  981, 1048,  785, 4241,  808, 2010, 3835, 3718, 1099,
         3735, 2061,  618, 2982,  831, 1850, 2703,  535, 4824, 2622, 4294,  810,
          323]
# seed_nodes_5 = [4542, 4891,    3, 3663, 2688, 1565, 1983,  483,  633, 3324, 3635, 4195,
#          2569, 4444, 1569, 1498, 1773, 4788, 3831, 2195,  600,  634, 3569, 4642,
#          2421, 4877, 3069,  981, 1048,  785, 4241,  808, 2010, 3835, 3718, 1099,
#          3735, 2061,  618, 2982,  831, 1850, 2703,  535, 4824, 2622, 4294,  810,
#           323, 1855, 3068, 3574, 2677, 2095,  101, 2722, 1401, 4099, 2417, 2821,
#          2363,  925,  267, 3815,  169,  524, 1954,  443, 2165,  967, 4464, 3737,
#           419, 2924, 1173, 3959, 4278, 3946, 3335, 4869,  574, 3071, 1834, 3362,
#          4227, 2015, 2063, 3846, 1269,  667, 1548, 4479, 4608, 1641,   71, 1308,
#          2805,  740, 1107,  789,  571, 3470, 4695, 3998, 1566, 1288, 1407, 2370,
#          3708, 2575, 2305, 3425, 3170, 4565, 3943, 4726, 4403, 4735, 4814, 1273,
#          2343, 4931, 3913, 2647, 4490,  152, 1146, 1160, 3882, 3102, 4519, 2326,
#          4584, 4476, 3403, 3106, 4395, 3872, 3950, 3805,  907, 3119, 2169, 3705,
#          3982, 1364, 2761, 4622, 4189, 1511, 1832,  997, 3325,  305, 3898,  307,
#          1182, 3512,  192,   21, 3423, 1473, 1221, 2698, 3223,  737, 2121,  207,
#          1707, 2590, 3922, 3645, 2136, 1805, 1126, 3098, 4710, 3548,  525, 2013,
#          2592, 2768, 1651, 3212, 1245, 2300, 3772, 3975, 3689, 2846,  197,  869,
#          1572, 2514, 3201, 3591,  980, 1226, 3385, 1485, 1315,  856, 4053, 4425,
#          1908,  847, 3502, 4704, 2628, 4844,  673, 3949,  820, 1549, 2294, 1823,
#           516, 1195, 1611, 4768, 4198, 2608, 2028, 4110, 2086, 2125, 3073, 3676,
#          4766,   24, 3710, 4866, 3118, 1543, 2966, 1617, 2865, 1389,   16,  557,
#          1313, 1120, 4173,   68, 1094, 3448, 3826]
# seed_nodes_1 = [4361, 3895, 2553, 4373, 4345, 1334, 1224, 4359, 1460,  831 , 846, 2545, 2800 ,1098,
#  4384, 3343, 2554, 4332, 2932, 2221, 3838, 2662, 2382, 3128,  854 ,4402, 1090 ,2574,
#  1554, 1166, 2617 ,3351, 4878, 2607, 4336, 4346, 4395 ,3468 , 725, 2717, 1050, 1326,
#  2434, 3329, 4392, 2740, 4391, 4381, 2548, 2959 , 129, 2760,   98, 2936, 2798, 2249,
#   396, 2542, 2575, 2608]
seed_nodes_1 = [4542, 3663, 4891,  633, 4195, 4565, 3959,  483, 1498, 3815, 3635, 4642,
        2569, 1565, 2010,  831, 3324, 2688, 2677,    3, 1983, 2722, 4584, 2326,
        1099, 1569, 2703,  535, 2061, 1773, 3335, 4444, 2305, 1855, 2421, 4476,
        3737, 1805,  808, 4824, 2721,  323, 4464,  785, 3805, 3212, 3512, 1473,
        2165]

#DeepIMd seed

# seed_nodes_1 = [4296, 2647, 831, 4381, 3956, 3316, 1039, 4158, 3151, 4855, 3158, 891, 4388, 242, 2575, 13, 3267, 2439, 463, 2834, 3393, 383, 1180, 3351, 1403
# , 1482, 4566, 2553, 3051, 844, 1929, 1674, 1440, 3361, 945, 2084, 978, 2021, 1920, 2533, 2487, 4313, 1528, 4495, 2418, 363, 4505, 2434, 2180, 96, 2211, 2125, 1541, 2304]
# [2764, 1784,   87, 1814,  178, 2749,  631, 2656, 2134, 1395, 2681,  193,
#          1348, 2614, 2704,  272,  525, 1821,  843, 2647, 1476, 2666, 1506, 1715,
#          1591, 1462, 1535, 1306]
# [1784,   87, 2656, 2749, 1814,  193, 2134,  525, 1476, 2666, 2681, 2764,
#           631, 1395,  974, 1591, 1790, 1739, 2294, 1715, 1280,  722, 2625, 2704,
#          2614, 1744, 2338, 1964]
# seed_nodes_5 = [831, 2553, 4181, 2575, 4224, 2647, 597, 895, 2538, 3355, 2694, 4520, 2439, 3725, 848, 1460, 2596, 2585, 1166, 3178, 4209, 4157, 2502, 1060, 1530, 4155, 2800, 3316, 2617, 4574, 3312, 3329, 2662, 1419, 1206, 1542, 1268, 3940, 2952, 2761, 4352, 3343, 4076, 3796, 4314, 2434, 2519, 4158, 2554, 1736, 3783, 2450, 920, 2832, 1980, 1476, 3632, 1030, 2728, 2922, 2717, 3310, 3359, 3307, 1403, 539, 1326, 36, 2608, 2601, 4063, 4073, 4704, 1968, 490, 2850, 4100, 3351, 1459, 2533, 2918, 1356, 3277, 396, 4032, 2500, 4361, 1511, 4691, 908, 447, 3789, 2824, 3331, 680, 846, 2932, 4568, 4297, 252, 574, 2542, 852, 3798, 2548, 4342, 1472, 4371, 4256, 2515, 251, 624, 3344, 2524, 4553, 4311, 1486, 4195, 3574, 1500, 1986, 2860, 1353, 1962, 4310, 2572, 3468, 4273, 386, 154, 2975, 1105, 2433, 3554, 833, 1026, 4521, 314, 1776, 1106, 1474, 2324, 3218, 552, 1734, 1614, 3488, 3096, 3352, 4203, 537, 1342, 4765, 4308, 392, 1570, 1175, 1170, 4249, 2363, 4561, 3673, 1321, 4602, 1005, 4283, 3094, 1210,
#  337, 4385, 559, 577, 424, 157, 730, 2496, 305, 4594, 3401, 4138, 888, 1164, 2409, 3009, 3643, 384, 1200, 4295, 37, 3648, 2321, 4098, 2606, 2763, 3678, 854, 266, 3176, 1006, 4894, 4075, 932, 1489, 2384, 247, 4269, 1300, 1517, 1866, 3258, 4404, 1159
# , 796, 3347, 3173, 4282, 4368, 454, 3271, 4855, 4262, 1658, 2593, 4372, 4287, 1751, 2683, 2876, 4491, 4513, 4121, 280, 2944, 4921, 548, 4029, 2959, 2135, 759, 1862, 3290, 2534, 4501, 2681, 3246, 1713, 2569, 2619, 4090, 3877, 3771, 2485, 1989, 2246,
#  636, 905, 242, 2530, 1361, 4458, 1435, 3633, 686, 4613, 743, 3918, 2852, 4696, 2444, 2504, 919, 3270, 4901, 957, 4065, 4261, 1192, 1938, 2156, 471, 1547, 657, 4223, 1933, 119, 426, 2825, 2512, 3253, 1117, 1147, 594, 3068, 2936, 4281, 1173, 3325, 4564, 1087, 2946, 1528, 784, 340, 1237, 4535, 3067, 1095, 4620, 58, 3663, 2912, 2081, 4419, 3914, 2834, 777, 4837, 275, 599, 4403, 3638, 3034, 3954, 2855, 2549, 849, 2427, 3005, 166, 3215, 3724, 4271]


# IC模型信息传播函数
def independent_cascade(graph, seed_nodes_5, p=0.5):
    influenced_nodes = set(seed_nodes_5)
    active_nodes = list(seed_nodes_5)

    while active_nodes:
        new_active_nodes = []
        for node in active_nodes:
            neighbors = graph.edge_index[1, graph.edge_index[0] == node].tolist()
            for neighbor in neighbors:
                if neighbor not in influenced_nodes:
                    # 根据边权值和传播概率决定是否传播
                    edge_idx = (graph.edge_index[0] == node) & (graph.edge_index[1] == neighbor)
                    if random.random() < graph.edge_attr[edge_idx].item():
                        influenced_nodes.add(neighbor)
                        new_active_nodes.append(neighbor)
        active_nodes = new_active_nodes
        num = len(influenced_nodes)
        influenced = num/num_node

    return influenced_nodes, num, influenced

def ic_propagation(edge_index, edge_weight, initial_active_nodes, num_nodes):
    active_nodes = initial_active_nodes[:]
    newly_active_nodes = initial_active_nodes[:]

    while newly_active_nodes:
        current_active_nodes = newly_active_nodes[:]
        newly_active_nodes = []

        for edge in range(edge_index.size(1)):
            src, dst = edge_index[:, edge]
            if src.item() in current_active_nodes and dst.item() not in active_nodes:
                prob = edge_weight[edge].item()
                if random.uniform(0.0, 0.7) <= prob:
                    newly_active_nodes.append(dst.item())
                    active_nodes.append(dst.item())
        active_nodes = list(active_nodes)
        num = len(active_nodes)
        influenced = num/num_nodes

    return active_nodes, num, influenced


# 运行IC模型
a = []
for i in range(30):
    # influenced_nodes, num, influenced = independent_cascade(graph, seed_nodes_1, p=0.5)
    final_active_nodes, num, influenced= ic_propagation(index, e, seed_nodes_5, num_node)
    a.append(influenced)
    print(f'最终影响的节点集: {final_active_nodes}')
    print(f'最终影响的节点集个数: {num}')
    print(f'最终影响的节点集比例: {influenced}')
print(a)
h = 0
l = []
for i in a:
    if i >0.0:
        h = h + i
        l.append(i)
h1 = h/len(l)
print(f'均值为：{h1}')
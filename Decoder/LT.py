import torch
from torch_geometric.data import Data
import random
import numpy as np
import scipy.sparse as sp
import pickle

# 创建包含198个节点和边权值的图数据
def normalize_adj(mx):
    """Row-normalize sparse matrix（行规范化稀疏矩阵）"""
    rowsum = np.array(mx.sum(1))  # 每行相加的和
    r_inv_sqrt = np.power(rowsum, -0.5).flatten()
    r_inv_sqrt[np.isinf(r_inv_sqrt)] = 0.
    r_mat_inv_sqrt = sp.diags(r_inv_sqrt)  # 生成对角矩阵
    return mx.dot(r_mat_inv_sqrt).transpose().dot(r_mat_inv_sqrt)  # transpose函数相当于换索引位置，类似于转置


# with open('/home/pmy/DeepIM/data/jazz.SG', 'rb') as f:
#     graph = pickle.load(f)
with open('/home/pmy/DeepIM/data/cora-ICI-10.pkl', 'rb') as f:
    graph = pickle.load(f)

adj, inverse_pairs = graph['adj'], graph['inverse_pairs']
num_node = adj.shape[0]
dataFea = torch.zeros([num_node, 1], dtype=torch.float32)

adj = adj + adj.T.multiply(adj.T > adj) - adj.multiply(adj.T > adj)
adj = normalize_adj(adj + sp.eye(adj.shape[0]))
adj = torch.Tensor(adj.toarray()).to_sparse()
index = adj.indices()
e = adj.values()
num_node = adj.shape[0]
graph = Data(x=dataFea, edge_index=index, edge_attr=e)


# 定义种子节点集JAZZ
# seed_nodes_20 = [190, 161,  74,  7,  59, 195,  58,  72, 122,  39, 112,  79, 167, 187,
#         116,  43,  40, 102,  65,  68, 139, 183,  18,  62, 127,  36,  60,  24,
#         176, 129, 119, 47, 105, 154,  29, 109,  94,  38, 146, 136]
# seed_nodes_10 = [190, 161,  74,   7,  59, 195,  58,  72, 122,  39, 112,  79, 167, 187,
#         116,  43,  40, 102,  65,  68]
# seed_nodes_5 = [190, 161,  74,   7,  59, 195,  58,  72, 122,  39]
# seed_nodes_1 = [190, 161]

#定义种子节点集-CORA_ML-86%-2810
seed_nodes_20 = [2764, 2681, 2656,  631, 2134, 2614,  463, 1784,   87, 1814, 1476, 1739,
         1306, 1591, 1395, 1375, 2704,  551, 1462, 1790, 1506, 2666,  193,   51,
          201, 1821, 2338, 2020, 1853,  525,  786, 2647, 1681,  122,  531,  843,
          705, 1280,   49, 2096, 1226,  165, 2195,  696, 2705,  679,  981, 2566,
          246, 2398, 2131, 1781, 2391, 2749,  211, 1579, 1540,  900, 1914,   40,
          972,   15, 1508, 1098,  673, 2625,  275,   99, 1297, 1905,  776,  796,
          178, 1412, 1964,  834, 2645, 1344, 2283,  722, 1852,   62,  753, 1230,
          713, 1460, 1434, 1997, 1471, 1174,  562,  676,  974, 2145, 2277, 1672,
         1826, 2433, 2754, 1348,   69,  423, 2780,  587, 1369, 1451, 2438, 2324,
         1516,  866, 1927,  179,  272,  569,  168,  515,  433, 2151, 1662, 1535,
         1851, 2294,  831,  887,  456,  791,   89, 2219, 1551,  493,  422, 2669,
          755,  520, 2714, 2426, 1744,  359,  825, 1491,  630, 2549, 1246, 2570,
         1557, 1787,  746,  320, 2322, 1673, 2155, 2745, 2672, 1686,  511, 1079,
         1638, 1022, 1183, 1341, 1194, 1945,  579, 2567, 2177, 1795,   10,  878,
         1007, 1406, 1196, 2147,  781, 2259,    4, 1288, 1974,   42, 2618,  408,
         1585,  125, 1615,  914, 1537, 1041, 1715,    3, 1769,  619, 1310,  478,
         1648,  300,  386,  457,  461, 1397, 1675, 2613,  298, 2546, 1836, 2152,
          701, 1614, 1319,   94, 1890, 2320,  583,  524, 1755,  529,  342, 2520,
          876, 1458, 1729, 2684, 1605, 2323,  992, 1909,  249, 2751,  546, 2361,
         2624, 1573, 2489, 1677,  189,  885, 1101, 2300,  350, 2029, 2535, 2365,
          800, 1679, 1877, 1805,  904, 1817,  667,  804, 2122, 2328,  256, 1317,
         1704, 2765,  371, 1976, 1454, 1251, 2104, 1897,  158,  417, 2221,  929,
         1582,  443, 1298, 1346,  129, 1295,  618, 2746, 2202, 2369,  864, 1720,
          541, 2226, 1466, 1847,  853, 1678,  559, 2502, 2386,  726, 1002, 2183,
          644,  402,  911,   29, 1300,  875,  815,  740,  223,  918, 2080,  549,
         2181,  333,  732, 1696,  826, 2574, 2527,   17, 1037, 2085, 2024,   59,
         1513, 1473, 2413, 2770, 2069,   96, 1173,  170, 1062, 2410,  612, 1351,
         2702, 1523,   85,  869, 2592, 1303, 1370,  533, 1040,  840, 1512, 2331,
          182, 1968,  595, 1789, 1394, 1823, 1480,  692,  807,  986,  708, 2040,
         1301, 2554,   35,  859, 1687, 1716, 2165,  536,  195, 2348, 2112, 1706,
         2058,  186, 2510, 1235, 2648, 2469, 1665, 1448, 2736,  965, 2189, 1981,
         2230,  481, 1907,  234, 1598, 1651, 2725, 1453, 2650, 1692, 1941, 1985,
         2550,  145, 2023,  735,  634, 1154,  797,  504,  933, 2411,  236, 1493,
         1350, 1440, 1077, 2655,  297, 2233, 1410, 2289,  181, 2798, 2708, 1187,
         2161, 1142, 1158,  156,  116,  106, 2148, 2530, 1979, 1066, 1031, 1589,
          205,   71, 1555,  475, 1359, 1822,  799, 2481, 2638,  123, 2129, 2130,
         2275, 2417,   46, 1875, 2687, 1820, 1505, 2731, 1859,  265, 2461, 1486,
           39, 1960, 2213, 2218,  955, 1751,  413, 1542, 2432,  502, 2790, 2081,
         1276,  765,  725, 2000, 2454, 2541,  677, 2062,  335,  388, 1785,  370,
          811, 2380,  588,  829, 1259, 1993, 1195, 2089, 1792, 2308, 1039, 1337,
         2175, 2719,  353, 2596,  662,  284,  355, 1134,  414, 2223, 1117, 2462,
          227, 2496,  431,  877, 1211, 1602, 2054, 2404,  906,  946, 2382, 2166,
         2168, 1721,  778, 1450, 1474,  166,    7, 2013,   58, 1843, 2556, 2514,
         1205,  748, 2601, 1804,  789, 2022,  733,  194, 1619,  176,  594, 2802,
         2092,  361, 1016,  954,  633, 2268, 1644,  995,  718,  458, 2354,  172,
          835, 2333, 1761,  210, 1969, 2273, 2633, 1663,  719, 2456, 2504, 1324,
         1017,   64, 1093, 2580, 1388, 2696, 2427, 2091, 2016, 1315]

seed_nodes_10 = [2764, 2681, 2656,  631, 2134, 2614,  463, 1784,   87, 1814, 1476, 1739,
         1306, 1591, 1395, 1375, 2704,  551, 1462, 1790, 1506, 2666,  193,   51,
          201, 1821, 2338, 2020, 1853,  525,  786, 2647, 1681,  122,  531,  843,
          705, 1280,   49, 2096, 1226,  165, 2195,  696, 2705,  679,  981, 2566,
          246, 2398, 2131, 1781, 2391, 2749,  211, 1579, 1540,  900, 1914,   40,
          972,   15, 1508, 1098,  673, 2625,  275,   99, 1297, 1905,  776,  796,
          178, 1412, 1964,  834, 2645, 1344, 2283,  722, 1852,   62,  753, 1230,
          713, 1460, 1434, 1997, 1471, 1174,  562,  676,  974, 2145, 2277, 1672,
         1826, 2433, 2754, 1348,   69,  423, 2780,  587, 1369, 1451, 2438, 2324,
         1516,  866, 1927,  179,  272,  569,  168,  515,  433, 2151, 1662, 1535,
         1851, 2294,  831,  887,  456,  791,   89, 2219, 1551,  493,  422, 2669,
          755,  520, 2714, 2426, 1744,  359,  825, 1491,  630, 2549, 1246, 2570,
         1557, 1787,  746,  320, 2322, 1673, 2155, 2745, 2672, 1686,  511, 1079,
         1638, 1022, 1183, 1341, 1194, 1945,  579, 2567, 2177, 1795,   10,  878,
         1007, 1406, 1196, 2147,  781, 2259,    4, 1288, 1974,   42, 2618,  408,
         1585,  125, 1615,  914, 1537, 1041, 1715,    3, 1769,  619, 1310,  478,
         1648,  300,  386,  457,  461, 1397, 1675, 2613,  298, 2546, 1836, 2152,
          701, 1614, 1319,   94, 1890, 2320,  583,  524, 1755,  529,  342, 2520,
          876, 1458, 1729, 2684, 1605, 2323,  992, 1909,  249, 2751,  546, 2361,
         2624, 1573, 2489, 1677,  189,  885, 1101, 2300,  350, 2029, 2535, 2365,
          800, 1679, 1877, 1805,  904, 1817,  667,  804, 2122, 2328,  256, 1317,
         1704, 2765,  371, 1976, 1454, 1251, 2104, 1897,  158,  417, 2221,  929,
         1582,  443, 1298, 1346,  129, 1295,  618, 2746, 2202, 2369,  864, 1720,
          541, 2226, 1466, 1847,  853]

seed_nodes_5 = [2764, 2681, 2656,  631, 2134, 2614,  463, 1784,   87, 1814, 1476, 1739,
         1306, 1591, 1395, 1375, 2704,  551, 1462, 1790, 1506, 2666,  193,   51,
          201, 1821, 2338, 2020, 1853,  525,  786, 2647, 1681,  122,  531,  843,
          705, 1280,   49, 2096, 1226,  165, 2195,  696, 2705,  679,  981, 2566,
          246, 2398, 2131, 1781, 2391, 2749,  211, 1579, 1540,  900, 1914,   40,
          972,   15, 1508, 1098,  673, 2625,  275,   99, 1297, 1905,  776,  796,
          178, 1412, 1964,  834, 2645, 1344, 2283,  722, 1852,   62,  753, 1230,
          713, 1460, 1434, 1997, 1471, 1174,  562,  676,  974, 2145, 2277, 1672,
         1826, 2433, 2754, 1348,   69,  423, 2780,  587, 1369, 1451, 2438, 2324,
         1516,  866, 1927,  179,  272,  569,  168,  515,  433, 2151, 1662, 1535,
         1851, 2294,  831,  887,  456,  791,   89, 2219, 1551,  493,  422, 2669,
          755,  520, 2714, 2426, 1744,  359,  825, 1491]

# seed_nodes_1 = [2764, 2681, 2656,  631, 2134, 2614,  463, 1784,   87, 1814, 1476, 1739,
#          1306, 1591, 1395, 1375, 2704,  551, 1462, 1790, 1506, 2666,  193,   51,
#           201, 1821, 2338, 2020]

seed_nodes_1 =[4542, 4891,    3, 3663, 2688, 1565, 1983,  483,  633, 3324, 3635, 4195,
         2569, 4444, 1569, 1498, 1773, 4788, 3831, 2195,  600,  634, 3569, 4642,
         2421, 4877, 3069,  981, 1048,  785, 4241,  808, 2010, 3835, 3718, 1099,
         3735, 2061,  618, 2982,  831, 1850, 2703,  535, 4824, 2622, 4294,  810,
          323]



# LT模型信息传播函数
def linear_threshold(graph, seed_nodes_1, thresholds):
    influenced_nodes = set(seed_nodes_1)
    active_nodes = list(seed_nodes_1)

    while active_nodes:
        new_active_nodes = []
        for node in range(graph.num_nodes):
            if node not in influenced_nodes:
                neighbors = graph.edge_index[0, graph.edge_index[1] == node].tolist()
                total_influence = sum(
                    graph.edge_attr[(graph.edge_index[0] == neighbor) & (graph.edge_index[1] == node)].item() for
                    neighbor in neighbors if neighbor in influenced_nodes)
                if total_influence >= thresholds[node]:
                    influenced_nodes.add(node)
                    new_active_nodes.append(node)
        active_nodes = new_active_nodes
        num = len(influenced_nodes)
        influenced = num / num_node

    return influenced_nodes, num, influenced


# 运行LT模型
a = []
for i in range(30):
    thresholds = torch.rand(num_node)
    thresholds = thresholds * 0.5
    influenced_nodes, num, influenced = linear_threshold(graph, seed_nodes_1, thresholds)
    a.append(influenced)
    print(f'最终影响的节点集: {influenced_nodes}')
    print(f'最终影响的节点集个数: {num}')
    print(f'最终影响的节点集比例: {influenced}')
print(a)
# h = 0
# l = []
# for i in a:
#     if i >0.6:
#         h = h + i
#         l.append(i)
# h1 = h/len(l)
# print(f'均值为：{h1}')
